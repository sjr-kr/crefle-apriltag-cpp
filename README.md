# Crefle AprilTag 추적기 (C++)

이 프로젝트는 AprilTag를 사용하여 카메라 캘리브레이션 및 실시간 3D 객체 추적을 수행하는 C++ 시스템입니다. Python으로 작성된 원본 프로젝트의 핵심 기능을 C++로 이식하여 성능을 최적화했습니다.

## 주요 기능

- **카메라 캘리브레이션**: 체커보드 패턴을 사용하여 카메라의 내부 파라미터와 왜곡 계수를 계산합니다.
- **AprilTag 생성**: 지정된 ID의 AprilTag 마커 이미지를 생성하고 저장합니다.
- **실시간 AprilTag 감지**: 라이브 카메라 피드에서 AprilTag 마커를 감지하고 각 마커의 3D 포즈(위치 및 방향)를 추정합니다.
- **플랫폼 기반 상대 추적**: 4개의 AprilTag 마커로 구성된 기준 플랫폼을 설정하고, 이 플랫폼에 대한 객체 마커의 상대 3D 좌표 및 회전(Roll, Pitch, Yaw)을 계산합니다.

---

## 전제 조건

이 프로젝트를 빌드하고 실행하려면 시스템에 다음 라이브러리가 설치되어 있어야 합니다.

- **OpenCV (4.x 권장)**: 컴퓨터 비전 기능을 위한 필수 라이브러리입니다.
- **AprilTag (3.x 권장)**: AprilTag 감지를 위한 라이브러리입니다.

macOS에서 Homebrew를 사용하는 경우, 다음 명령어로 설치할 수 있습니다.

```bash
brew install opencv apriltag
```

---

## 빌드 방법

프로젝트를 빌드하려면 `CMake`를 사용합니다. 프로젝트 루트 디렉토리에서 다음 명령어를 실행하세요.

1.  **빌드 디렉토리 생성 및 이동**:
    ```bash
    mkdir build
    cd build
    ```

2.  **CMake 실행하여 빌드 파일 생성**:
    ```bash
    cmake ..
    ```

3.  **프로젝트 컴파일**:
    ```bash
    make
    ```

빌드가 성공적으로 완료되면 `build` 디렉토리 내에 `calibrate`, `track`, `generate_markers` 세 개의 실행 파일이 생성됩니다.

---

## 워크플로우

### 1단계: AprilTag 마커 생성

1.  `build` 디렉토리에서 `generate_markers` 실행 파일을 실행합니다.
    ```bash
    ./generate_markers
    ```
2.  생성할 AprilTag ID 목록(공백으로 구분)을 입력합니다. 마커 이미지의 크기는 자동으로 500x500 픽셀로 설정됩니다.
3.  지정된 ID의 AprilTag 이미지가 `generated_markers` 디렉토리에 PNG 파일로 저장됩니다.

### 2단계: 카메라 캘리브레이션

1.  물리적인 체커보드를 준비합니다.
2.  `build` 디렉토리에서 `calibrate` 실행 파일을 실행합니다.
    ```bash
    ./calibrate
    ```
3.  터미널의 안내에 따라 카메라 인덱스, 체커보드 내부 코너 개수, 사각형의 실제 크기(미터 단위)를 입력합니다.
4.  카메라 피드가 나타나면 다양한 각도와 거리에서 체커보드를 비춥니다. 스페이스바를 눌러 이미지를 캡처합니다. (최소 15-20장 권장)
5.  캡처가 완료되면 `ESC` 키를 눌러 종료합니다. 캘리브레이션 데이터는 프로젝트 루트에 `calibration_data.yml` 파일로 저장됩니다.

### 3단계: 플랫폼 시스템 실행

1.  ID가 0, 1, 2, 3인 AprilTag 마커를 정사각형 형태로 배치하여 기준 플랫폼을 구성합니다. 객체 추적에는 ID 10 마커를 사용합니다.
2.  `build` 디렉토리에서 `track` 실행 파일을 실행합니다.
    ```bash
    ./track
    ```
3.  터미널의 안내에 따라 카메라 인덱스, 마커의 실제 크기, 플랫폼의 한 변의 길이를 미터 단위로 입력합니다.
4.  시스템이 카메라를 통해 AprilTag를 감지합니다. 감지된 모든 마커 위에는 해당 마커의 ID가 표시됩니다.
5.  객체 마커(ID 10)가 감지되면 그 위에 녹색 큐브가 그려집니다. 이 큐브는 마커를 감싸는 대신 마커 위에 위치합니다.
6.  플랫폼 마커(ID 0, 1, 2, 3)가 모두 감지되면 플랫폼의 중심에 좌표축이 표시됩니다.
7.  플랫폼 마커가 모두 감지된 경우에만, 객체 마커의 상대 3D 좌표(밀리미터 단위)와 회전 정보(Roll, Pitch, Yaw 각도)가 화면에 출력됩니다.
8.  `ESC` 키를 눌러 프로그램을 종료합니다.

---

## 파일 설명

| 파일 | 설명 |
| :--- | :--- |
| `CMakeLists.txt` | `CMake` 빌드 시스템을 위한 설정 파일입니다. |
| `README.md` | 프로젝트 설명 및 안내 문서입니다. |
| `src/camera_calibration.hpp` | 카메라 캘리브레이션 기능의 헤더 파일입니다. |
| `src/camera_calibration.cpp` | `calibrate` 실행 파일의 전체 소스 코드입니다. 캘리브레이션 로직과 `main` 함수를 모두 포함합니다. |
| `src/generate_markers.hpp` | AprilTag 생성 기능의 헤더 파일입니다. |
| `src/generate_markers.cpp` | `generate_markers` 실행 파일의 전체 소스 코드입니다. 마커 생성 로직과 `main` 함수를 모두 포함합니다. |
| `src/platform_logic.hpp` | 플랫폼 좌표계 계산 및 상대 위치/회전 변환 로직의 헤더 파일입니다. |
| `src/platform_logic.cpp` | 플랫폼 변환, 상대 좌표/회전 계산, 3D 시각화(축, 큐브) 등 핵심 3D 연산을 구현합니다. |
| `src/run_platform_system.hpp` | 플랫폼 추적 시스템의 헤더 파일입니다. |
| `src/run_platform_system.cpp` | `track` 실행 파일의 메인 함수로, AprilTag 감지 및 추적 결과를 화면에 표시하는 전체 로직을 포함합니다. |